/*
 * Sigida.Triggers_Atmega8.c
 *
 * Created: 16-Dec-20 9:10:14 AM
 * Author : den1s
 */ 

#include <avr/io.h>
#include <util/delay.h>
#include "lib_trig.h"

#define RSTRIGGER (PINC&0x01)==0
#define JKTRIGGER (PINC&0x02)==0
#define DTRIGGER (PINC&0x04)==0
#define TTRIGGER (PINC&0x08)==0

#define R_BUTTON (PIND&0x01)==0
#define S_BUTTON (PIND&0x02)==0
#define J_BUTTON (PIND&0x04)==0
#define K_BUTTON (PIND&0x08)==0
#define D_BUTTON (PIND&0x10)==0
#define C_BUTTON (PIND&0x20)==0
#define T_BUTTON (PIND&0x40)==0

int main(void)
{
	//???????????? ?????? I/O
	PORTB=0x00;
	DDRB=0xFF;
	PORTD=0xFF;
	DDRD=0x00;
	PORTC=0xFF;
	DDRC=0x00;

	while (1)
	{
		//?????????? ? ??????? ???????? ????????? ???????
		char chooseTrigger;
		
		//???? ?????? ????????, ????????? ????? ??????? ??? ??????
		//? ?? ???????? ?? ??? ???????? ????????????, ???? ?? ????
		//??????? ?? ????????, ?? ????????? ???????????.
		while (trigger_selection(&chooseTrigger) && CheckButtonTriggres())
		{
			if (chooseTrigger=="RS"){
				PORTB = CallTriigerRS(R_BUTTON,S_BUTTON);
			}else if (chooseTrigger=="JK"){
				CallTriigerJK(J_BUTTON,K_BUTTON,0b00000100,0b00001000,&PORTB);
				}else if (chooseTrigger=="D"){
					CallTriigerD(D_BUTTON,C_BUTTON,0b00100000,0b00010000,&PORTB);
					}else if (chooseTrigger=="T"){
						CallTriigerT(T_BUTTON, 0b01000000,0b10000000,&PORTB);
					}else reload();
		}
		
		reload();
	}

}

//??????? ???????? ????? ??????? ??? ??????
//?????????: nameTrigger - ????????? ?? ?????? ? ?????? ??? ?????? ????? ????????
//?????????? 1 ???? ??????? ??????, ?????????? 0 ???? ?????? ?? ???????
int trigger_selection (int * nameTrigger)
{
	//???? ????????? ????? ??????? ??????, ???? ???????? ?? ??? ???
	//???? ???? ?? ????????? ?? ???????.
	do
	{
		if(RSTRIGGER) {*nameTrigger = "RS"; return 1;}
		else if(JKTRIGGER) {*nameTrigger = "JK"; return 1;}
		else if(DTRIGGER) {*nameTrigger = "D"; return 1;}
		else if(TTRIGGER) {*nameTrigger = "T"; return 1;}
		else return 0;
	} while (RSTRIGGER&JKTRIGGER&DTRIGGER&TTRIGGER==1);
}

int CheckButtonTriggres ()
{
	
	while ((RSTRIGGER) && (JKTRIGGER) || (TTRIGGER) && (DTRIGGER) || (JKTRIGGER) && (TTRIGGER) || (RSTRIGGER) && (DTRIGGER) || (DTRIGGER) && (JKTRIGGER))
	{
		PORTB=0xFF;
		_delay_ms(150);
		PORTB=0x00;
		_delay_ms(150);
		PORTB=0xFF;
		_delay_ms(150);
	}
	
	return 1;
}

